<div
    class="fixed left-0 top-0 bg-black/70 w-screen h-screen flex justify-center items-center z-50"
    (click)="cerrar.emit()"
>
    <div hlmCard (click)="$event.stopPropagation()" class="min-w-xs md:min-w-md">
        <div hlmCardHeader class="faster-fade-in">
            <div class="flex items-center gap-4">
                <ng-icon hlm name="lucideSquarePen" />
                <h3 hlmH3 hlmCardTitle>{{ titulo }}</h3>
            </div>
        </div>
        <div hlmCardContent class="faster-fade-in">
            @if (descripcion) {
                <p hlmP class="text-center text-balance mx-1" [innerHTML]="descripcion"></p>
            }
            <fieldset hlmFieldSet>
                <div hlmFieldGroup class="gap-3">
                    @for (campo of campos; track campo.llave) {
                        @if (campo.tipo !== 'oculto') {
                            <div hlmField class="gap-1">
                                @if (campo.tipo === 'string' || campo.tipo === 'number') {
                                    <label
                                        [for]="campo.llave"
                                        hlmLabel
                                        class="opacity-80 font-semibold whitespace-nowrap text-xs md:text-sm px-2"
                                        >{{ campo.nombre ?? campo.llave }}</label
                                    >
                                    <div hlmInputGroup>
                                        @if (campo.tipo === 'string') {
                                            <input
                                                hlmInputGroupInput
                                                type="text"
                                                class="transition-all duration-500 ease-out text-xs md:text-sm"
                                                [id]="campo.llave"
                                                [formControl]="form.controls[campo.llave]"
                                            />
                                        }
                                        @if (campo.tipo === 'number') {
                                            <input
                                                hlmInputGroupInput
                                                type="number"
                                                class="transition-all duration-500 ease-out text-xs md:text-sm"
                                                [id]="campo.llave"
                                                [formControl]="form.controls[campo.llave]"
                                            />
                                        }
                                    </div>
                                }
                                @if (campo.tipo === 'boolean') {
                                    <div class="flex justify-end-safe items-center gap-4">
                                        <label
                                            [for]="campo.llave"
                                            hlmLabel
                                            class="opacity-80 font-semibold text-xs md:text-sm"
                                            >{{ campo.nombre ?? campo.llave }}</label
                                        >
                                        <hlm-switch
                                            [id]="campo.llave"
                                            class="scale-[120%]"
                                            [checked]="form.controls[campo.llave].value"
                                            (checkedChange)="
                                                form.controls[campo.llave].setValue($event)
                                            "
                                        />
                                        @if (form.controls[campo.llave].value) {
                                            <ng-icon
                                                hlm
                                                name="lucideBadgeCheck"
                                                class="text-green-700"
                                            />
                                        } @else {
                                            <ng-icon
                                                hlm
                                                name="lucideBadgeX"
                                                class="text-destructive"
                                            />
                                        }
                                    </div>
                                }
                                @if (campo.tipo === 'select') {
                                    <div class="flex justify-start items-center gap-4">
                                        <label
                                            [for]="campo.llave"
                                            hlmLabel
                                            class="opacity-80 font-semibold text-xs md:text-sm pl-2 whitespace-nowrap"
                                            >{{ campo.nombre ?? campo.llave }}</label
                                        >
                                        <brn-select
                                            [id]="campo.llave"
                                            class="inline-block z-10 w-full"
                                            [formControl]="form.controls[campo.llave]"
                                        >
                                            <hlm-select-trigger class="">
                                                <div class="flex justify-start items-center gap-2">
                                                    <hlm-select-value
                                                        class="text-xs md:text-sm truncate"
                                                    />
                                                </div>
                                            </hlm-select-trigger>
                                            <hlm-select-content>
                                                @for (
                                                    posibleValor of campo.posiblesValores;
                                                    track posibleValor.id
                                                ) {
                                                    <hlm-option
                                                        [value]="posibleValor.id"
                                                        class="text-xs md:text-sm"
                                                        >{{ `${posibleValor.valor}` }}</hlm-option
                                                    >
                                                }
                                            </hlm-select-content>
                                        </brn-select>
                                    </div>
                                }
                                @if (campo.tipo === 'autocomplete') {
                                    <div class="flex justify-start items-center gap-4">
                                        <label
                                            [for]="campo.llave"
                                            hlmLabel
                                            class="opacity-80 font-semibold text-xs md:text-sm pl-2 whitespace-nowrap"
                                            >{{ campo.nombre ?? campo.llave }}</label
                                        >
                                        <hlm-autocomplete
                                            [(search)]="campo.autocompleteSearch!"
                                            [itemToString]="campo.autocompleteItemToString!"
                                            [isItemEqualToValue]="
                                                campo.autocompleteIsItemEqualToValue!
                                            "
                                            [formControl]="form.controls[campo.llave]"
                                            class="w-full"
                                        >
                                            <hlm-autocomplete-input
                                                [id]="campo.llave"
                                                [placeholder]="
                                                    `Seleccionar ${campo.nombre?.toLocaleLowerCase()}...`
                                                "
                                                class="text-xs md:text-sm"
                                                showClear
                                            />
                                            <div *brnPopoverContent hlmAutocompleteContent>
                                                <hlm-autocomplete-empty
                                                    >{{ campo.nombre }} no
                                                    encontrad@...</hlm-autocomplete-empty
                                                >
                                                <div hlmAutocompleteList>
                                                    @for (
                                                        grupo of campo.autocompleteFilteredOptions!();
                                                        track $index;
                                                        let last = $last
                                                    ) {
                                                        <div hlmAutocompleteGroup>
                                                            <div hlmAutocompleteLabel>
                                                                {{ grupo.categoria }}
                                                            </div>
                                                            @for (
                                                                option of grupo.items;
                                                                track $index
                                                            ) {
                                                                <hlm-autocomplete-item
                                                                    [value]="option.id"
                                                                >
                                                                    {{ option.valor }}
                                                                </hlm-autocomplete-item>
                                                            }
                                                            @if (!last) {
                                                                <div hlmAutocompleteSeparator></div>
                                                            }
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        </hlm-autocomplete>
                                    </div>
                                }
                                <hlm-field-error
                                    class="transition-all duration-500 ease-out"
                                    [class.opacity-100]="invalid(campo.llave)"
                                    [class.opacity-0]="!invalid(campo.llave)"
                                    [class.max-h-10]="invalid(campo.llave)"
                                    [class.max-h-0]="!invalid(campo.llave)"
                                    >Debes ingresar el "{{
                                        campo.nombre ?? campo.llave
                                    }}"</hlm-field-error
                                >
                            </div>
                        }
                    }
                </div>
            </fieldset>
        </div>
        <div hlmCardFooter class="flex items-center justify-end gap-6 faster-fade-in">
            <button hlmBtn variant="secondary" (click)="cerrar.emit()">Cancelar</button>
            <button hlmBtn (click)="confirmar()" [disabled]="form.invalid">
                {{ textoBotonGuardar }}
            </button>
        </div>
        @if (conFuncionSecundaria) {
            <hlm-separator class="faster-fade-in" />
            <div hlmCardContent class="faster-fade-in">
                @if (descripcionSecundaria) {
                    <p
                        hlmP
                        class="text-center text-balance mx-1"
                        [innerHTML]="descripcionSecundaria"
                    ></p>
                }
            </div>
            <div hlmCardFooter class="flex items-center justify-end gap-2 md:gap-4 faster-fade-in">
                <button
                    hlmBtn
                    (click)="funcionSecundaria.emit(this.form.getRawValue())"
                    [disabled]="form.invalid"
                >
                    {{ textoBotonSecundario }}
                </button>
            </div>
        }
    </div>
</div>
